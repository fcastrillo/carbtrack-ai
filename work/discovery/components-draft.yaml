# work/discovery/components-draft.yaml
# Generated by /rai-discover-scan
# Review with /rai-discover-validate

generated_at: "2026-02-12T20:35:00Z"
source_commands:
  - "rai discover scan frontend/src --language typescript"
  - "rai discover scan supabase/functions --language typescript"
symbol_count: 42

components:

  # ─── Module: lib/supabase.ts ───────────────────────────────────────────
  - id: comp-supabase-supabase
    name: supabase
    kind: constant
    file: frontend/src/lib/supabase.ts
    line: 10
    signature: "const supabase"
    docstring: null
    purpose: "Singleton Supabase client instance initialized from VITE env vars. Used by all services for DB, Storage, and Edge Function calls."
    category: service
    depends_on:
      - "@supabase/supabase-js.createClient"
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  # ─── Module: services/mealService.ts ───────────────────────────────────
  - id: comp-mealservice-analyzeitem
    name: AnalyzeItem
    kind: type_alias
    file: frontend/src/services/mealService.ts
    line: 7
    signature: "type AnalyzeItem"
    docstring: null
    purpose: "Represents a single food item returned by the analyze-meal Edge Function, including name, carb grams, measure, and source (educadies or vision_only)."
    category: model
    depends_on: []
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-mealservice-analyzeresponse
    name: AnalyzeResponse
    kind: type_alias
    file: frontend/src/services/mealService.ts
    line: 14
    signature: "type AnalyzeResponse"
    docstring: null
    purpose: "Response shape from analyze-meal Edge Function containing detected food items, total carbs, and optional error."
    category: model
    depends_on:
      - AnalyzeItem
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-mealservice-mealrecord
    name: MealRecord
    kind: type_alias
    file: frontend/src/services/mealService.ts
    line: 20
    signature: "type MealRecord"
    docstring: null
    purpose: "Write payload for inserting a meal into meal_history table (image_url, ai_analysis, confirmed carbs, timestamp)."
    category: model
    depends_on: []
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-mealservice-validateimagefile
    name: validateImageFile
    kind: function
    file: frontend/src/services/mealService.ts
    line: 28
    signature: "function validateImageFile(file: File): { ok: true } | { ok: false; message: string }"
    docstring: "Validate file size and type before upload (spec edge case: image too large or unsupported format)"
    purpose: "Guard function that validates image file type (JPEG/PNG/WebP) and size (max 5MB) before upload to Storage."
    category: utility
    depends_on: []
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-mealservice-uploadimage
    name: uploadImage
    kind: function
    file: frontend/src/services/mealService.ts
    line: 39
    signature: "function uploadImage(file: File): Promise<{ url: string; path: string }>"
    docstring: "Upload image to Storage, get public URL"
    purpose: "Uploads a meal photo to the meal-images Storage bucket with a UUID filename and returns the public URL."
    category: service
    depends_on:
      - supabase.storage
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-mealservice-analyzemeal
    name: analyzeMeal
    kind: function
    file: frontend/src/services/mealService.ts
    line: 51
    signature: "function analyzeMeal(imageUrl: string): Promise<AnalyzeResponse>"
    docstring: "Call Edge Function analyze-meal with image_url; parse response per contracts/edge-functions.md"
    purpose: "Invokes the analyze-meal Edge Function with an image URL and returns AI-detected food items with carb estimates."
    category: service
    depends_on:
      - supabase.functions
      - AnalyzeResponse
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-mealservice-uploadandanalyze
    name: uploadAndAnalyze
    kind: function
    file: frontend/src/services/mealService.ts
    line: 69
    signature: "function uploadAndAnalyze(file: File): Promise<{ response: AnalyzeResponse; imageUrl: string }>"
    docstring: "Upload image, then call analyze-meal. Returns response and the Storage public URL to persist."
    purpose: "Orchestrates the full meal capture flow: validates, uploads image to Storage, then calls AI analysis. Primary entry point for CaptureMeal component."
    category: service
    depends_on:
      - validateImageFile
      - uploadImage
      - analyzeMeal
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-mealservice-savemeal
    name: saveMeal
    kind: function
    file: frontend/src/services/mealService.ts
    line: 78
    signature: "function saveMeal(record: MealRecord): Promise<{ id: string }>"
    docstring: "Insert row into meal_history (image_url, ai_analysis, user_confirmed_carbs, timestamp)"
    purpose: "Persists a confirmed meal record to the meal_history table in Supabase."
    category: service
    depends_on:
      - supabase
      - MealRecord
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-mealservice-mealentry
    name: MealEntry
    kind: type_alias
    file: frontend/src/services/mealService.ts
    line: 94
    signature: "type MealEntry"
    docstring: "Row from meal_history for display"
    purpose: "Read model for meal_history rows used in HoyPage and BitacoraPage displays."
    category: model
    depends_on:
      - AnalyzeItem
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-mealservice-gettodaymeals
    name: getTodayMeals
    kind: function
    file: frontend/src/services/mealService.ts
    line: 103
    signature: "function getTodayMeals(): Promise<MealEntry[]>"
    docstring: "Get meals for today (local date); sum of user_confirmed_carbs = total CH del día (spec SC-002)"
    purpose: "Fetches today's meals from meal_history for the HoyPage daily carb total display."
    category: service
    depends_on:
      - getMealsByRange
      - MealEntry
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-mealservice-getmealsbyrange
    name: getMealsByRange
    kind: function
    file: frontend/src/services/mealService.ts
    line: 111
    signature: "function getMealsByRange(start: Date, end: Date): Promise<MealEntry[]>"
    docstring: "Get meals in date range (for Bitácora); start/end in local time."
    purpose: "Queries meal_history by date range, ordered by timestamp descending. Core data access for Bitácora and Laboratorio pages."
    category: service
    depends_on:
      - supabase
      - MealEntry
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  # ─── Module: services/csvUploadService.ts ──────────────────────────────
  - id: comp-csvuploadservice-importcsvresult
    name: ImportCsvResult
    kind: type_alias
    file: frontend/src/services/csvUploadService.ts
    line: 3
    signature: "type ImportCsvResult"
    docstring: null
    purpose: "Response shape from import-carelink-csv Edge Function with entry/treatment counts and success status."
    category: model
    depends_on: []
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-csvuploadservice-uploadcarelinkcsv
    name: uploadCareLinkCsv
    kind: function
    file: frontend/src/services/csvUploadService.ts
    line: 12
    signature: "function uploadCareLinkCsv(csvContent: string): Promise<ImportCsvResult>"
    docstring: "Send CSV content to Edge Function import-carelink-csv; returns counts or error."
    purpose: "Sends CareLink CSV content to the import-carelink-csv Edge Function for Nightscout synchronization."
    category: service
    depends_on:
      - supabase.functions
      - ImportCsvResult
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  # ─── Module: services/catalogService.ts ────────────────────────────────
  - id: comp-catalogservice-addtocatalogpayload
    name: AddToCatalogPayload
    kind: type_alias
    file: frontend/src/services/catalogService.ts
    line: 3
    signature: "type AddToCatalogPayload"
    docstring: null
    purpose: "Write payload for inserting a user-suggested food item into master_food_list (Educadies catalog)."
    category: model
    depends_on: []
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-catalogservice-addtocatalog
    name: addToCatalog
    kind: function
    file: frontend/src/services/catalogService.ts
    line: 11
    signature: "function addToCatalog(payload: AddToCatalogPayload): Promise<{ id: string }>"
    docstring: "Insert one row into master_food_list (T023: \"Agregar al catálogo\")"
    purpose: "Inserts a user-suggested food into the Educadies master_food_list so it can be matched in future AI analyses."
    category: service
    depends_on:
      - supabase
      - AddToCatalogPayload
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  # ─── Module: services/profileService.ts ────────────────────────────────
  - id: comp-profileservice-pumpprofile
    name: PumpProfile
    kind: type_alias
    file: frontend/src/services/profileService.ts
    line: 3
    signature: "type PumpProfile"
    docstring: null
    purpose: "Read model for pump_profile table row containing ISF and I:C ratio values."
    category: model
    depends_on: []
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-profileservice-getprofile
    name: getProfile
    kind: function
    file: frontend/src/services/profileService.ts
    line: 11
    signature: "function getProfile(): Promise<PumpProfile | null>"
    docstring: "Get single pump_profile row (MVP: one row for implicit user)."
    purpose: "Fetches the single pump profile row containing ISF and I:C ratio for the implicit MVP user."
    category: service
    depends_on:
      - supabase
      - PumpProfile
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-profileservice-saveprofile
    name: saveProfile
    kind: function
    file: frontend/src/services/profileService.ts
    line: 22
    signature: "function saveProfile(isf: number, ratio_ic: number): Promise<void>"
    docstring: "Save pump_profile (single row for MVP: update existing or insert)."
    purpose: "Upserts pump profile ISF and I:C ratio values. Creates new row if none exists, updates existing otherwise."
    category: service
    depends_on:
      - supabase
      - getProfile
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  # ─── Module: App.tsx ───────────────────────────────────────────────────
  - id: comp-app-app
    name: App
    kind: function
    file: frontend/src/App.tsx
    line: 9
    signature: "function App()"
    docstring: null
    purpose: "Root application component. Sets up React Router with 5 page routes and the persistent BottomNav navigation bar."
    category: handler
    depends_on:
      - react-router-dom.BrowserRouter
      - BottomNav
      - HoyPage
      - BitacoraPage
      - LaboratorioPage
      - CargaDatosPage
      - PerfilPage
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  # ─── Module: components/BottomNav.tsx ──────────────────────────────────
  - id: comp-bottomnav-bottomnav
    name: BottomNav
    kind: function
    file: frontend/src/components/BottomNav.tsx
    line: 12
    signature: "function BottomNav()"
    docstring: null
    purpose: "Fixed bottom navigation bar with 5 tabs (Hoy, Bitácora, Laboratorio, Carga de Datos, Perfil) using NavLink for active state."
    category: component
    depends_on:
      - react-router-dom.NavLink
      - lucide-react
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  # ─── Module: components/MealCard.tsx ───────────────────────────────────
  - id: comp-mealcard-props
    name: Props
    kind: type_alias
    file: frontend/src/components/MealCard.tsx
    line: 3
    signature: "type Props"
    docstring: null
    purpose: "Props type for MealCard component, accepting a MealEntry."
    category: model
    depends_on:
      - MealEntry
    internal: true
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-mealcard-mealcard
    name: MealCard
    kind: function
    file: frontend/src/components/MealCard.tsx
    line: 6
    signature: "function MealCard({ meal }: Props)"
    docstring: "Tarjeta: Foto, resumen de alimentos (ai_analysis), CH confirmados (spec: Hoy, Bitácora)"
    purpose: "Displays a meal entry as a card with photo thumbnail, AI-detected food summary, and confirmed carb count."
    category: component
    depends_on:
      - MealEntry
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  # ─── Module: components/FilterBar.tsx ──────────────────────────────────
  - id: comp-filterbar-bitacorafilter
    name: BitacoraFilter
    kind: type_alias
    file: frontend/src/components/FilterBar.tsx
    line: 1
    signature: "type BitacoraFilter"
    docstring: null
    purpose: "Union type for Bitácora time filter options: all, today, week, month, custom."
    category: model
    depends_on: []
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-filterbar-props
    name: Props
    kind: type_alias
    file: frontend/src/components/FilterBar.tsx
    line: 3
    signature: "type Props"
    docstring: null
    purpose: "Props type for FilterBar component including current filter value, change handler, and custom date range callbacks."
    category: model
    depends_on:
      - BitacoraFilter
    internal: true
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-filterbar-filterbar
    name: FilterBar
    kind: function
    file: frontend/src/components/FilterBar.tsx
    line: 20
    signature: "function FilterBar({ value, onChange, customStart, customEnd, onCustomStartChange, onCustomEndChange }: Props)"
    docstring: null
    purpose: "Time filter chip bar for Bitácora page with preset ranges (Todas, Hoy, Semana, Mes) and custom date range inputs."
    category: component
    depends_on:
      - BitacoraFilter
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  # ─── Module: components/CaptureMeal.tsx ────────────────────────────────
  - id: comp-capturemeal-step
    name: Step
    kind: type_alias
    file: frontend/src/components/CaptureMeal.tsx
    line: 10
    signature: "type Step"
    docstring: null
    purpose: "State machine type for meal capture flow: select → analyzing → confirm → saved | error."
    category: model
    depends_on: []
    internal: true
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-capturemeal-capturemeal
    name: CaptureMeal
    kind: function
    file: frontend/src/components/CaptureMeal.tsx
    line: 12
    signature: "function CaptureMeal()"
    docstring: null
    purpose: "Multi-step meal capture wizard: photo upload, AI analysis display, carb confirmation/edit, save to DB, and add-to-catalog for vision_only items."
    category: component
    depends_on:
      - uploadAndAnalyze
      - saveMeal
      - addToCatalog
      - AnalyzeItem
      - AnalyzeResponse
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  # ─── Module: pages/HoyPage.tsx ─────────────────────────────────────────
  - id: comp-hoypage-hoypage
    name: HoyPage
    kind: function
    file: frontend/src/pages/HoyPage.tsx
    line: 7
    signature: "function HoyPage()"
    docstring: null
    purpose: "Today's dashboard page showing daily carb total, list of today's meals via MealCard, and FAB to open CaptureMeal."
    category: handler
    depends_on:
      - getTodayMeals
      - CaptureMeal
      - MealCard
      - MealEntry
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  # ─── Module: pages/BitacoraPage.tsx ────────────────────────────────────
  - id: comp-bitacorapage-getrangeforfilter
    name: getRangeForFilter
    kind: function
    file: frontend/src/pages/BitacoraPage.tsx
    line: 8
    signature: "function getRangeForFilter(filter: BitacoraFilter, customStart: string, customEnd: string): { start: Date; end: Date }"
    docstring: null
    purpose: "Converts a BitacoraFilter selection into a concrete Date range for querying meal_history."
    category: utility
    depends_on:
      - BitacoraFilter
    internal: true
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-bitacorapage-bitacorapage
    name: BitacoraPage
    kind: function
    file: frontend/src/pages/BitacoraPage.tsx
    line: 45
    signature: "function BitacoraPage()"
    docstring: null
    purpose: "Meal history page with time-based FilterBar and MealCard list. Shows empty state when no meals match the selected filter."
    category: handler
    depends_on:
      - FilterBar
      - MealCard
      - getMealsByRange
      - BitacoraFilter
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  # ─── Module: pages/LaboratorioPage.tsx ─────────────────────────────────
  - id: comp-laboratoriopage-laboratoriopage
    name: LaboratorioPage
    kind: function
    file: frontend/src/pages/LaboratorioPage.tsx
    line: 6
    signature: "function LaboratorioPage()"
    docstring: null
    purpose: "Recommendations page showing weekly meal count and placeholder for CareLink glucose cross-analysis (future feature)."
    category: handler
    depends_on:
      - getMealsByRange
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  # ─── Module: pages/CargaDatosPage.tsx ──────────────────────────────────
  - id: comp-cargadatospage-cargadatospage
    name: CargaDatosPage
    kind: function
    file: frontend/src/pages/CargaDatosPage.tsx
    line: 5
    signature: "function CargaDatosPage()"
    docstring: null
    purpose: "CareLink CSV upload page. Reads CSV file, sends to import-carelink-csv Edge Function, and displays entry/treatment counts."
    category: handler
    depends_on:
      - uploadCareLinkCsv
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  # ─── Module: pages/PerfilPage.tsx ──────────────────────────────────────
  - id: comp-perfilpage-perfilpage
    name: PerfilPage
    kind: function
    file: frontend/src/pages/PerfilPage.tsx
    line: 6
    signature: "function PerfilPage()"
    docstring: null
    purpose: "Profile page for manual ISF and I:C ratio entry. Loads existing pump_profile and allows save/update."
    category: handler
    depends_on:
      - getProfile
      - saveProfile
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  # ─── Module: test-utils/mockSupabase.ts ────────────────────────────────
  - id: comp-mocksupabase-mocksupabase
    name: mockSupabase
    kind: constant
    file: frontend/src/test-utils/mockSupabase.ts
    line: 2
    signature: "const mockSupabase"
    docstring: "Mock Supabase client for tests (Constitución II: no llamar a APIs reales)."
    purpose: "Test double for the Supabase client. Stubs from(), storage, and functions.invoke() with deterministic responses."
    category: test
    depends_on: []
    internal: false
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  # ─── Module: supabase/functions/analyze-meal/index.ts ──────────────────
  # Note: This Edge Function is a Deno serve() handler, not an exported function.
  # The function has no extractable named symbols beyond the serve() call.
  # Documented as a module-level component.

  # ─── Module: supabase/functions/import-carelink-csv/index.ts ───────────
  - id: comp-import-carelink-csv-findblocks
    name: findBlocks
    kind: function
    file: supabase/functions/import-carelink-csv/index.ts
    line: 13
    signature: "function findBlocks(lines: string[]): [number, number | null] | null"
    docstring: null
    purpose: "Locates the one or two 'Index,Date,Time,...' header rows in a CareLink CSV to identify data block boundaries."
    category: parser
    depends_on: []
    internal: true
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-import-carelink-csv-isdatarow
    name: isDataRow
    kind: function
    file: supabase/functions/import-carelink-csv/index.ts
    line: 23
    signature: "function isDataRow(line: string): boolean"
    docstring: null
    purpose: "Checks if a CSV line is a data row (starts with a digit) vs. a blank or header line."
    category: utility
    depends_on: []
    internal: true
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-import-carelink-csv-parsedatetime
    name: parseDateTime
    kind: function
    file: supabase/functions/import-carelink-csv/index.ts
    line: 30
    signature: "function parseDateTime(dateStr: string, timeStr: string): Date | null"
    docstring: null
    purpose: "Parses CareLink date/time format (YYYY/MM/DD HH:MM:SS) into a JavaScript Date object."
    category: parser
    depends_on: []
    internal: true
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-import-carelink-csv-parsecsv
    name: parseCSV
    kind: function
    file: supabase/functions/import-carelink-csv/index.ts
    line: 42
    signature: "function parseCSV(header: string, dataLines: string[]): Record<string, string>[]"
    docstring: null
    purpose: "Splits CSV header and data lines into an array of key-value row objects."
    category: parser
    depends_on: []
    internal: true
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-import-carelink-csv-processtreatments
    name: processTreatments
    kind: function
    file: supabase/functions/import-carelink-csv/index.ts
    line: 54
    signature: "function processTreatments(lines: string[], headerIdx: number, dataEndIdx: number): object[]"
    docstring: null
    purpose: "Extracts Nightscout treatment entries (Meal Bolus with BWZ Carb Input) from the first CareLink CSV data block."
    category: parser
    depends_on:
      - parseCSV
      - parseDateTime
      - isDataRow
    internal: true
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-import-carelink-csv-processentries
    name: processEntries
    kind: function
    file: supabase/functions/import-carelink-csv/index.ts
    line: 75
    signature: "function processEntries(lines: string[], headerIdx: number): object[]"
    docstring: null
    purpose: "Extracts Nightscout SGV entries (Sensor Glucose values) from the second CareLink CSV data block."
    category: parser
    depends_on:
      - parseCSV
      - parseDateTime
      - isDataRow
    internal: true
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"

  - id: comp-import-carelink-csv-posttonightscout
    name: postToNightscout
    kind: function
    file: supabase/functions/import-carelink-csv/index.ts
    line: 103
    signature: "function postToNightscout(baseUrl: string, apiSecretHash: string, endpoint: \"entries\" | \"treatments\", batch: object[]): Promise<{ status: number; ok: boolean }>"
    docstring: null
    purpose: "Sends a batch of entries or treatments to the Nightscout API with SHA-1 authenticated API-SECRET header."
    category: service
    depends_on: []
    internal: true
    validated: true
    validated_by: human
    validated_at: "2026-02-12T20:40:00Z"
